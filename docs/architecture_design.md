# 多协议采集控制器系统架构设计

## 1. 系统概述

多协议采集控制器是一个企业级的分布式采集管理系统，支持SSH、SNMP、API等多种协议，通过统一的管理界面实现设备管理、任务调度、采集器监控和结果处理。

## 2. 技术架构

### 2.1 分层架构
- **用户层**: Web浏览器、移动端、第三方系统
- **前端层**: React + TypeScript + Ant Design
- **网关层**: Nginx负载均衡和SSL终端
- **应用层**: Django + DRF微服务架构
- **中间件层**: XXL-Job、RabbitMQ、Redis
- **数据层**: MySQL主从架构
- **采集器层**: 分布式采集器节点

### 2.2 核心模块

#### 2.2.1 设备管理模块
- 设备信息CRUD操作
- 设备分组和标签管理
- 设备状态监控
- 协议参数配置

#### 2.2.2 任务管理模块
- 任务创建和调度配置
- 批量任务操作
- 任务执行状态监控
- 任务历史记录

#### 2.2.3 服务区管理模块
- SSH服务器管理
- 免密登录配置
- WebSocket终端服务
- 心跳检测机制
- 一键部署采集器

#### 2.2.4 采集器管理模块
- 采集器自动注册
- 状态监控和性能指标
- 负载均衡和故障转移
- 采集器分组管理

#### 2.2.5 结果处理模块
- 采集结果接收和存储
- 数据筛选和导出
- 趋势分析和报表
- 异常告警机制

#### 2.2.6 系统管理模块
- 用户权限管理
- 操作日志记录
- 系统配置管理
- 监控告警配置

## 3. 采集器子项目集成架构

### 3.1 采集器项目结构
```
collector-projects/
├── SSHCollector/           # Python版SSH采集器
│   ├── src/               # 核心源码
│   ├── addone/            # 插件系统
│   ├── docs/              # 项目文档
│   ├── scripts/           # 部署脚本
│   └── tests/             # 测试用例
├── SSHCollectorPro/       # Go版SSH采集器
│   ├── cmd/               # 命令行入口
│   ├── internal/          # 内部模块
│   ├── pkg/               # 公共包
│   ├── api/               # API接口
│   ├── addone/            # 插件系统
│   ├── docs/              # 项目文档
│   └── test/              # 测试用例
└── collector-sdk/         # 采集器SDK（规划中）
    ├── python/            # Python SDK
    ├── golang/            # Go SDK
    └── common/            # 通用组件
```

### 3.2 集成设计原则

#### 3.2.1 独立性原则
- **开发独立**: 各采集器项目独立开发、测试、部署
- **技术栈独立**: 支持不同编程语言和技术栈
- **版本独立**: 各项目独立版本管理和发布周期
- **运行独立**: 采集器进程独立运行，互不影响

#### 3.2.2 统一性原则
- **接口统一**: 统一的注册、心跳、任务接收接口
- **配置统一**: 统一的配置管理和下发机制
- **监控统一**: 统一的性能监控和日志收集
- **部署统一**: 统一的部署脚本和容器化方案

### 3.3 采集器注册与发现机制

#### 3.3.1 注册流程
```
采集器启动 → 读取配置 → 向控制器注册 → 获取任务配置 → 开始工作
```

#### 3.3.2 注册信息
- 采集器ID和类型（SSH/SNMP/API）
- 版本信息和能力描述
- 网络地址和端口
- 支持的设备类型和协议
- 性能参数（并发数、内存等）

#### 3.3.3 心跳机制
- 定期向控制器发送心跳
- 上报运行状态和性能指标
- 接收配置更新和任务分配

### 3.4 任务分发与亲和性调度

#### 3.4.1 亲和性配置
- **地理亲和性**: 区域、城市、数据中心
- **网络亲和性**: VLAN、网段、网络质量
- **设备亲和性**: 设备类型、厂商、协议版本
- **性能亲和性**: CPU、内存、并发能力

#### 3.4.2 调度算法
- 基于亲和性评分的智能调度
- 负载均衡和故障转移
- 动态调整和优化

### 3.5 配置管理与同步

#### 3.5.1 配置层级
```
全局配置 → 采集器类型配置 → 采集器实例配置 → 任务配置
```

#### 3.5.2 配置同步机制
- 配置变更实时推送
- 采集器配置热更新
- 配置版本管理和回滚

## 4. 数据流向

```
用户操作 → 前端界面 → API网关 → Django应用 → 数据库
                                    ↓
任务调度 ← XXL-Job ← 任务队列 ← 消息队列 ← Django应用
    ↓
采集器执行 → 结果回传 → 消息队列 → Django应用 → 数据库
```

## 5. 高可用设计

### 5.1 数据库高可用
- MySQL主从复制
- 读写分离
- 自动故障转移

### 5.2 应用层高可用
- Django多实例部署
- Nginx负载均衡
- 健康检查机制

### 5.3 任务调度高可用
- XXL-Job集群部署
- 任务分片执行
- 故障自动转移

### 5.4 消息队列高可用
- RabbitMQ集群
- 消息持久化
- 自动重连机制

### 5.5 采集器高可用
- 多采集器实例部署
- 故障自动检测和转移
- 任务重试和补偿机制

## 6. 安全设计

### 6.1 认证授权
- JWT Token认证
- RBAC权限控制
- API访问限流

### 6.2 数据安全
- 敏感信息加密存储
- 数据传输SSL加密
- 操作日志审计

### 6.3 网络安全
- VPN/专线接入
- 防火墙规则
- 入侵检测

### 6.4 采集器安全
- 采集器身份认证
- 通信加密和签名
- 权限最小化原则

## 7. 性能优化

### 7.1 缓存策略
- Redis缓存热点数据
- 数据库查询优化
- 静态资源CDN

### 7.2 异步处理
- 消息队列异步任务
- WebSocket实时通信
- 批量操作优化

### 7.3 监控告警
- 系统性能监控
- 业务指标监控
- 自动告警机制

### 7.4 采集器性能优化
- 连接池和资源复用
- 并发控制和限流
- 内存和CPU优化

## 8. 部署架构

### 8.1 容器化部署
- Docker镜像标准化
- Kubernetes编排管理
- 自动扩缩容机制

### 8.2 多环境支持
- 开发、测试、生产环境隔离
- 配置文件环境化管理
- CI/CD自动化流水线

### 8.3 采集器部署策略
- 一键部署脚本
- 容器化部署方案
- 分布式部署架构